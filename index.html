<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä»Šå¤©æ˜¯ä½ çš„ä¸“å±æ—¥å­å“¦è€å©†~</title>
    <style>
        /* å¼•å…¥ Google Fonts é«˜çº§è¡¬çº¿ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap');

        :root {
            /* è°ƒè‰²æ¿ */
            --bg-paper: #F9F4E8; /* ç¾Šçš®çº¸è‰² */
            --night-sky: #090910; /* æ·±ç©º */
            --text-primary: #3E2723; /* æ·±è¤ */
            --accent-red: #D32F2F;
            --gold: #FFD700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg-paper);
            color: var(--text-primary);
            height: 100vh; width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 3s ease-in-out;
        }

        /* --- 1. å…¨å±€ç‰¹æ•ˆå±‚ --- */
        
        /* èƒ¶ç‰‡å™ªç‚¹æ»¤é•œ (å¢åŠ ç”µå½±è´¨æ„Ÿ) */
        .film-grain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 9998; mix-blend-mode: overlay;
        }

        /* é»‘åœºè½¬åœº (æœ€é«˜å±‚çº§) */
        #black-curtain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000;
            opacity: 1; pointer-events: none;
            transition: opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ç²’å­ç”»å¸ƒ (çƒŸèŠ±ã€æµæ˜Ÿ) - å±‚çº§æå‡ä»¥ç¡®ä¿è§†è§‰æ•ˆæœ */
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 6000;
        }

        /* --- 2. èˆå°ç®¡ç† --- */
        .stage {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 1.5s ease;
            z-index: 10;
        }
        .stage.active { display: flex; opacity: 1; }

        /* --- Stage 1: ç¤¼ç›’ (å¢å¼ºäº¤äº’ç‰ˆ) --- */
        .box-container {
            position: relative; width: 220px; height: 220px;
            cursor: pointer; margin-top: 50px;
            perspective: 1000px;
            transition: transform 0.1s;
        }
        .box-body {
            position: absolute; bottom: 0; width: 100%; height: 75%;
            background: linear-gradient(135deg, #C03550, #8B0000);
            border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }
        .box-lid {
            position: absolute; top: 10%; left: -5%; width: 110%; height: 25%;
            background: linear-gradient(135deg, #E85A7C, #C03550);
            border-radius: 4px; z-index: 2;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: top center;
        }
        .ribbon {
            position: absolute; left: 50%; transform: translateX(-50%); width: 25px; height: 100%;
            background: linear-gradient(to right, #FFD700, #FDB931);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .box-bow {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            width: 70px; height: 35px;
            background: radial-gradient(circle at center, #FFD700, #FDB931);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* ä¸åŒçš„æ™ƒåŠ¨åŠ¨ç”» */
        .shake-mild { animation: shake-mild 0.5s ease-in-out; }
        .shake-hard { animation: shake-hard 0.5s ease-in-out; }
        .jump { animation: jump 0.5s ease-in-out; }
        .wobble { animation: wobble 0.5s ease-in-out; }
        .open .box-lid { transform: rotateX(120deg) translateY(-300px) scale(0.9); opacity: 0; }
        
        @keyframes shake-mild { 0%,100%{transform:rotate(0);} 25%{transform:rotate(-3deg);} 75%{transform:rotate(3deg);} }
        @keyframes shake-hard { 0%,100%{transform:rotate(0) scale(1);} 25%{transform:rotate(-8deg) scale(1.05);} 75%{transform:rotate(8deg) scale(1.05);} }
        @keyframes jump { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-30px) scale(1.1);} }
        @keyframes wobble { 0%,100%{transform:translateX(0%);} 15%{transform:translateX(-15%) rotate(-5deg);} 30%{transform:translateX(10%) rotate(3deg);} 45%{transform:translateX(-10%) rotate(-3deg);} 60%{transform:translateX(5%) rotate(2deg);} 75%{transform:translateX(-5%) rotate(-1deg);} }

        /* æç¤ºæ–‡å­—æ ·å¼ */
        #box-tip {
            margin-top: 60px; color: #999; font-size: 1rem; letter-spacing: 2px;
            transition: all 0.3s; height: 30px;
        }

        /* --- Stage 2: è‰è“ --- */
        .strawberry-item {
            position: absolute; font-size: 3.5rem; 
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.2));
            cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: float 3s ease-in-out infinite;
            z-index: 100;
        }
        .strawberry-item:active { transform: scale(1.4) rotate(15deg); }

        /* --- Stage 3: è›‹ç³•ä¸è®¸æ„¿ --- */
        .cake-stage-wrapper {
            position: relative; width: 320px; height: 320px;
            display: flex; justify-content: center; align-items: flex-end;
            margin-bottom: 60px;
            opacity: 0; transform: translateY(50px);
            transition: opacity 1.5s, transform 1.5s;
        }
        .cake-stage-wrapper.visible { opacity: 1; transform: translateY(0); }

        /* è›‹ç³•ä¸»ä½“ */
        .c-layer {
            position: absolute; bottom: 0; width: 240px; height: 100px;
            background: linear-gradient(to right, #fff, #f0f0f0);
            border-radius: 12px;
            box-shadow: inset 0 -10px 20px rgba(0,0,0,0.05), 0 20px 40px rgba(0,0,0,0.1);
        }
        .c-layer.top { bottom: 95px; width: 220px; height: 90px; z-index: 2; background: #FFF0F5; }
        
        /* å¥¶æ²¹æ·‹é¢ */
        .c-icing {
            position: absolute; bottom: 175px; width: 230px; height: 30px;
            background: #fff; border-radius: 20px; z-index: 3;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* è‰è“è£…é¥° (Z-Index = 10, é«˜äºèœ¡çƒ›åº•éƒ¨) */
        .c-berry {
            position: absolute; bottom: 180px; font-size: 2rem; z-index: 10;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.15));
            opacity: 0; transform: translateY(-30px); transition: all 0.8s;
        }
        .c-berry.p1 { left: 50px; bottom: 150px}
        .c-berry.p2 { left: 110px; bottom: 150px}
        .c-berry.p3 { left: 170px; bottom: 150px}
        .c-berry.p4 { left: 230px; bottom: 150px}

        /* èœ¡çƒ›ä¸»ä½“ (Z-Index = 20, ç¡®ä¿å¯ç‚¹å‡») */
        .c-candle {
            position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%);
            width: 16px; height: 0; /* åˆå§‹0 */
            background: repeating-linear-gradient(45deg, #fff, #fff 5px, #f0f0f0 5px, #f0f0f0 10px);
            z-index: 20; border-radius: 4px; 
            transition: height 1s ease;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* ç«è‹— (åˆå§‹å¿…é¡»å®Œå…¨éšè—) */
        .c-flame {
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%) scale(0);
            width: 18px; height: 40px;
            background: radial-gradient(ellipse at bottom, #fff 10%, #FFD700 40%, #FF4500 100%);
            border-radius: 50% 50% 20% 20%;
            filter: blur(1px); opacity: 0;
            transition: all 0.5s; pointer-events: none;
            transform-origin: bottom center;
        }
        /* æ¿€æ´»çŠ¶æ€ */
        .c-flame.active { 
            opacity: 1 !important; 
            transform: translateX(-50%) scale(1) !important; 
            animation: flicker 1.2s infinite alternate; 
        }

        /* å‘¼å¸å…‰æ™• */
        .ambient-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(255, 140, 0, 0.15), transparent 70%);
            opacity: 0; pointer-events: none; transition: opacity 2s; z-index: 1;
        }

        /* æ„¿æœ›çƒ (ç‹¬ç«‹å±‚çº§) */
        #wish-orb {
            position: fixed; width: 8px; height: 8px;
            background: #fff; border-radius: 50%;
            box-shadow: 0 0 20px #fff, 0 0 50px #FFD700;
            z-index: 7000; opacity: 0; pointer-events: none;
        }

        /* --- Stage 4: å®‡å®™ --- */
        #cosmos-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--night-sky); z-index: -1;
            opacity: 0; transition: opacity 4s;
        }
        
        /* å­”æ˜ç¯å®¹å™¨ */
        #lantern-container {
            position: fixed; top:0; left:0; width:100%; height:100%;
            pointer-events: none; z-index: 100;
            perspective: 1000px;
        }
        .lantern {
            position: absolute; width: 140px; height: 200px;
            background: #fff; padding: 10px 10px 40px 10px;
            /* æš–å…‰é˜´å½± */
            box-shadow: 0 0 40px rgba(255, 200, 100, 0.2), inset 0 0 30px rgba(255, 180, 50, 0.1);
            bottom: -300px; cursor: pointer; pointer-events: auto;
            transform-style: preserve-3d;
            animation: riseSway linear infinite;
        }
        .lantern img { width: 100%; height: 100%; object-fit: cover; filter: sepia(40%) contrast(1.1); }
        .lantern:hover { 
            transform: scale(1.15) !important; z-index: 500; 
            box-shadow: 0 0 60px rgba(255, 200, 100, 0.6); 
            transition: transform 0.3s;
        }

        /* æŒ‰é’®æ§åˆ¶æ  */
        #control-bar {
            position: fixed; bottom: 10%; width: 100%; text-align: center;
            opacity: 0; transition: opacity 2s; z-index: 8000;
            pointer-events: none;
        }
        .elegant-btn {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.9); padding: 12px 45px; border-radius: 50px;
            font-size: 1.1rem; font-family: 'Noto Serif SC', serif; letter-spacing: 3px;
            cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s;
            pointer-events: auto; box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .elegant-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .modal.show { opacity: 1; pointer-events: all; }
        .modal img { max-width: 85vw; max-height: 60vh; border: 6px solid #fff; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .modal p { color: #ddd; margin-top: 25px; font-size: 1.2rem; letter-spacing: 1px; }

        /* --- Stage 5: ä¿¡ä»¶ --- */
        .letter-scroll {
            width: 85%; max-width: 650px; height: 75vh;
            background: #fffdf7; 
            color: #2c2c2c; padding: 50px 40px; border-radius: 4px;
            box-shadow: 0 0 80px rgba(0,0,0,0.3);
            overflow-y: auto; line-height: 2.2; font-size: 1.15rem;
            position: relative; opacity: 0; transition: opacity 2s;
        }
        /* ä¿¡çº¸çº¹ç† */
        .letter-scroll::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 100% 2.2em; pointer-events: none; opacity: 0.4;
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} }
        @keyframes flicker { 
            0%,100%{opacity:1; transform:translateX(-50%) scale(1);} 
            50%{opacity:0.85; transform:translateX(-50%) scale(0.95);} 
        }
        @keyframes riseSway {
            0% { bottom: -300px; transform: translateX(0) rotate(0deg); }
            20% { transform: translateX(20px) rotate(2deg); }
            50% { transform: translateX(-20px) rotate(-1deg); }
            80% { transform: translateX(10px) rotate(1deg); }
            100% { bottom: 120vh; transform: translateX(0) rotate(0deg); }
        }
        @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} }
        /* --- æ–°å¢ï¼šå½©å¸¦ç²’å­æ ·å¼ --- */
        .confetti-piece {
            position: fixed;
            width: 8px; height: 12px;
            z-index: 9999; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
            pointer-events: none;
            opacity: 1;
        }
    </style>
</head>
<body>

    <audio id="bgm" loop><source src="music.mp3" type="audio/mpeg"></audio>
    <div onclick="toggleMusic()" style="position:fixed; top:25px; right:25px; z-index:10001; opacity:0.5; color:#888; cursor:pointer;">ğŸµ</div>

    <div id="black-curtain"></div>
    <canvas id="fireworks-canvas"></canvas>

    <div class="stage active" id="stage1">
        <h1 style="font-size:2rem; margin-bottom:50px; color:var(--accent-red); font-weight:normal; letter-spacing:2px; opacity:0; animation: fadeIn 2s forwards 1s;">ç¥ç§˜å°ç›’å­è€¶ï¼Œè€å©†å¿«æ‰“å¼€å®ƒ~</h1>
        <div class="box-container" id="gift-box" onclick="clickBox()">
            <div class="box-lid"><div class="ribbon"></div><div class="box-bow"></div></div>
            <div class="box-body"><div class="ribbon"></div></div>
        </div>
        <p id="box-tip" style="margin-top:50px; color:#999; letter-spacing:1px; opacity:0; animation: fadeIn 2s forwards 1.5s;">( è½»è§¦å¼€å¯ç¤¼ç‰© )</p>
    </div>

    <div class="stage" id="stage2">
        <h2 style="color:#555; font-weight:normal;">å’¦ï¼Ÿå¥‡æ€ªæ€ä¹ˆæœ¨æœ‰è›‹ç³•ç³•ï¼Œå¬è¯´æ”¶é›†4ä¸ªå°è‰è“å°±å¯ä»¥å¬å”¤è›‹ç³•å“¦</h2>
        <p id="berry-msg" style="color:#888; margin-bottom:40px;">è®©æˆ‘ä»¬ä¸€èµ·æ”¶é›†å°è‰è“å¬å”¤è›‹ç³•ç³•å§ã€‚ ğŸ“</p>
        <div style="width:100%; height:60vh; position:relative;" id="berry-area"></div>
        <div id="score" style="color:var(--accent-red); font-size:1.5rem;">0 / 5</div>
    </div>

    <div class="stage" id="stage3">
        <div class="ambient-glow" id="glow"></div>
        <div class="cake-stage-wrapper" id="cake-model">
            <div class="c-layer"></div>
            <div class="c-layer top"></div>
            <div class="c-icing"></div>
            <div class="c-berry p1">ğŸ“</div>
            <div class="c-berry p2">ğŸ“</div>
            <div class="c-berry p3">ğŸ“</div>
            <div class="c-berry p4">ğŸ“</div>
            <div class="c-candle" id="main-candle">
                <div class="c-flame" id="main-flame"></div>
            </div>
        </div>
        
        <div id="hint-text" style="text-align:center; color:#C03550; font-size:1.2rem; opacity:0; transition:opacity 1s; z-index:20;">
            å°å¥¶ç³•æ¥ç»™ä½ é€è›‹ç³•å’¯<br><span style="font-size:0.9rem; color:#888;">ç‚¹å‡»èœ¡çƒ›ç‚¹äº®å®ƒ ğŸ•¯ï¸</span>
        </div>
        
        <div id="blow-btn" style="margin-top:30px; opacity:0; transition:opacity 1s; pointer-events:none; z-index:20;">
            <button onclick="blowOut()" class="elegant-btn" style="color:#C03550; border-color:rgba(192, 53, 80, 0.3); background:rgba(255,255,255,0.6);">
                ğŸ’¨ å¹ç­è®¸æ„¿ ï¼ˆæ˜¯çœŸçš„å¯ä»¥å¹çš„å“¦å®å® å‘¼å‘¼å‘¼~ï¼‰
            </button>
        </div>
    </div>

    <div id="wish-orb"></div>

    <div id="cosmos-bg"></div>
    <div id="lantern-container"></div>
    
    <div id="control-bar">
        <p id="star-msg" style="color:rgba(255,255,255,0.7); margin-bottom:25px; letter-spacing:2px;">è€å©†å¤©å¤©å¼€å¿ƒï¼Œå¿ƒæƒ³äº‹æˆå“¦ï¼Œæ„¿æœ›éƒ½ä¼šå®ç°å“’~</p>
        <button id="photo-btn" class="elegant-btn" onclick="showLanterns()">âœ¨ ç‚¹å‡»æ¼‚æµ®çš„å›å¿† âœ¨</button>
        <button id="read-letter-btn" class="elegant-btn" style="display:none;" onclick="revealLetter()">æ‰“å¼€ä¿¡ä»¶ ğŸ’Œ</button>
    </div>

    <div class="modal" id="modal" onclick="closeModal()">
        <img id="modal-img" src="">
        <p id="modal-text"></p>
        <p style="color:#aaa; font-size:0.8rem; margin-top:30px;">( ç‚¹å‡»èƒŒæ™¯å…³é—­ )</p>
    </div>

    <div class="stage" id="stage5">
        <div class="letter-scroll" id="letter-box">
            <h2 style="text-align:center; color:var(--accent-red); margin-bottom:30px;">è‡´ æˆ‘æœ€çˆ±çš„è€å©†</h2>
            <div id="letter-content"></div>
            <hr style="margin:40px 0; border:0; border-top:1px dashed #ccc;">
            <div style="text-align:center; color:#888; font-size:0.9rem;">
                è·ç¦»ä¸‹ä¸€æ¬¡ç”Ÿæ—¥è¿˜æœ‰ï¼š<br>
                <span id="timer" style="color:var(--accent-red); font-weight:bold;">è®¡ç®—ä¸­...</span>
            </div>
        </div>
    </div>

    <script>
        // === 1. æ•°æ®é…ç½® ===
        const photos = [
            {src:"img1.jpg", text:"æˆ‘ä»¬çš„ç¬¬ä¸€æ¬¡æ—…è¡Œ"},
            {src:"img2.jpg", text:"è€å©†æˆ‘ä»¬ä¸€èµ·å»è§åˆ°äº†ä½ çš„ç«¥å¹´å¶åƒå“¦"},
            {src:"img3.jpg", text:"æˆ‘ä»¬æœ€å¼€å¿ƒçš„ä¸€æ¬¡æ—…è¡Œï¼"},
            {src:"img4.jpg", text:"æœ€å¹³å‡¡çš„å¹¸ç¦å˜¿å˜¿ï¼Œæœ‰ä½ çœŸå¥½è€å©†"},
            {src:"img5.jpg", text:"ç”Ÿæ—¥å¿«ä¹ï¼ï¼ï¼ï¼"}
        ];

        // ä¿¡ä»¶å†…å®¹ (å·²æ›¿æ¢ä¸ºä½ å†™çš„æ„Ÿäººç‰ˆæœ¬)
        const letterText = `
            <p>äº²çˆ±çš„å¼ è¯—æ‚¦/å¦å¦/å°æ¾é¼ /å°è›‹ç³•å°æœ‹å‹ï¼š</p>
            <p>ç”Ÿæ—¥å¿«ä¹ï¼Œmygirlã€‚</p>
            
            <p>è¿™æ˜¯æˆ‘ä»¬ä¸€èµ·åº¦è¿‡çš„ç¬¬äºŒä¸ªç”Ÿæ—¥ï¼Œè™½ç„¶æˆ‘ä»¬ä¹‹é—´éš”ç€è·ç¦»ï¼Œä½†æˆ‘çŸ¥é“ï¼Œè¿™ä»½æƒ³å¿µå’Œçˆ±æ„æ¯”å»å¹´æ›´æµ“ï¼Œä¹Ÿæ¯”ä»»ä½•å®ä½“ç¤¼ç‰©éƒ½æ›´æ²‰ç”¸ç”¸åœ°è£…åœ¨æˆ‘çš„å¿ƒåº•ã€‚</p>
            
            <p>æˆ‘ä¸€ç›´éƒ½å¯¹æˆ‘ä»¬ç›¸é‡çš„é‚£ä¸ªç¬é—´è®°å¿†çŠ¹æ–°ã€‚åœ¨å°˜åœŸé£æ‰¬çš„å†å²è¯¾ä¸Šï¼Œæˆ‘é¡¶ç€ä¸€å¤´â€œçˆ†ç‚¸å¤´â€ååˆ°äº†è€å©†çš„èº«è¾¹ã€‚é‚£ä¸ªç”»é¢åœ¨æˆ‘è„‘æµ·é‡Œæ°¸è¿œéƒ½æ˜¯å®šæ ¼çš„ï¼šä½ å®‰é™åœ°ä½å¤´çœ‹ç€æ‰‹æœºï¼Œç„¶åæ—¶ä¸æ—¶çš„çœ‹çœ‹è€å¸ˆï¼Œé‚£ä¸€æŠ¹å¤´é¡¶çš„å…‰çº¿å‹¾å‹’å‡ºäº†è€å©†å…¨ä¸–ç•Œæœ€å¥½çœ‹çš„ä¾§é¢œã€‚å¥½ç±³å¥½ç±³å¥½ç±³å‘€ï¼Œæˆ‘ç°åœ¨éƒ½è¿˜ä¼šåœ¨è„‘æµ·ä¸­å›å¿†é‚£ä¸ªæˆ´ç€å£ç½©çš„ç¥çº§ä¾§è„¸ã€‚é‚£æ˜¯ä¸¤å¹´å‰ï¼Œä¸€ä¸ªå¹³å‡¡ä¸è¿‡çš„ä¸‹åˆï¼Œä½†æ˜¯å´å¼€å¯äº†æˆ‘ç”Ÿå‘½ä¸­æœ€ä¸å¹³å‡¡çš„ä¸€æ®µæ—…ç¨‹ã€‚é‡åˆ°äº†æˆ‘è¿™ä¸€è¾ˆå­æœ€æƒ³æœ€æƒ³å®å®ˆçš„å®å®ã€‚</p>
            
            <p>è¿™ä¸¤å¹´çš„æ—¶é—´é‡Œï¼Œæˆ‘ä»ä½ çš„èº«ä¸Šçœ‹åˆ°äº†å¥½å¤šå¥½å¤šè®©æˆ‘æ•¬ä½©å’Œæ²‰é†‰çš„å…‰èŠ’ã€‚æˆ‘æœ‰å¾ˆå¤šçš„é”™ï¼Œä»¥åŠæˆ‘ä»¬ä¹‹é—´ä¹Ÿå‘ç”Ÿäº†å¥½å¤šå¥½å¤šçš„å†²çªï¼Œä½†æ˜¯æ— è®ºæœ€åå‘ç”Ÿä»€ä¹ˆï¼Œæˆ‘ä»¬éƒ½è¿˜æ˜¯ä¼šå› ä¸ºçˆ±ï¼Œè€Œåšå®šçš„é€‰æ‹©å¯¹æ–¹ã€‚</p>
            
            <p>ä½ æ˜¯æˆ‘è§è¿‡æœ€å–„è‰¯çš„å¥³å­©ï¼Œæ€»æ˜¯åœ¨ä¸ç»æ„é—´å¯¹è¿™ä¸ªä¸–ç•Œæ¸©æŸ”ä»¥å¾…ï¼Œéå¸¸çš„æœ‰è‡ªå·±çš„æ€æƒ³ï¼Œæˆ‘è¶…çº§å–œæ¬¢è¿™æ ·çš„ä½ ã€‚åŒæ—¶ï¼Œä½ åˆæœ‰ç€æƒŠäººçš„åšéŸ§ï¼Œé¢å¯¹ç”Ÿæ´»é‡Œçš„æŒ‘æˆ˜ï¼Œä½ æ€»æ˜¯é»˜é»˜æ¶ˆåŒ–ï¼Œç„¶åæ›´å¼ºå¤§åœ°ç«™èµ·æ¥ã€‚ï¼ˆè™½ç„¶æœ‰çš„æŒ‘æˆ˜æ˜¯æˆ‘æå‡ºæ¥å˜Ÿï¼‰ï¼Œæˆ‘è§‰å¾—å‘ç”Ÿäº†è¿™äº›äº‹æƒ…çš„æ—¶å€™æ˜¯ä½ æœ€è¿·äººæ—¶åˆ»ä¹‹ä¸€ï¼Œå› ä¸ºä½ ç»å¸¸ä¼šåƒä¸€ä¸ªå°å­©å­ä¸€æ ·å’Œæˆ‘å€¾è¯‰ï¼Œæˆ‘çœŸçš„å¥½å–œæ¬¢å¥½å–œæ¬¢è¿™æ ·çš„ä½ ï¼Œå˜¿å˜¿å¾ˆæœ‰è¢«è®¤åŒçš„æ„Ÿè§‰ã€‚</p>
            
            <p>è™½ç„¶ä½ ä¼šå¾ˆæ…Œä¹±å¾ˆç„¦ç¼ï¼Œæœ‰æ—¶å€™ä¹Ÿä¼šå¯¹ç€æˆ‘æ’’è„¾æ°”ã€‚ä½†æ˜¯ä½ å´ä¹Ÿæ€»æ˜¯èƒ½ä¸€ä¸€åŒ–è§£ã€‚å¹¶ä¸”å‚²å¨‡çš„å’Œæˆ‘è¯´å¯¹ä¸èµ·ï¼Œå¥½å¯çˆ±å¥½å¯çˆ±çš„ï¼Œå˜¿å˜¿ã€‚å‚²å¨‡å°é»‘çŒ«ã€‚è€å©†æˆ‘æƒ³è¯´ä½ çœŸçš„å¾ˆæ£’å‘€å®å®ï¼Œæœ‰çš„æ—¶å€™ä¹Ÿä¼šæ€•æˆ‘æ‹…å¿ƒè€Œä¸å’Œæˆ‘è¯´ï¼Œä½†æ˜¯å“¦å®å®ï¼Œæˆ‘è¿™ä¸€è¾ˆå­éƒ½è¦ç»™ä½ ï¼Œæ‰€ä»¥æ— è®ºä½ è¯´ä»€ä¹ˆæˆ‘éƒ½ä¸ä¼šæœ‰æ„è§ï¼Œæˆ‘éƒ½è¿˜æ˜¯ä¼šä¸€ç›´ä¸€æ ·çš„å¯¹å¾…ä½ çˆ±ä½ ã€‚å¸®ä½ æ’å¿§è§£éš¾æ˜¯æˆ‘æœ€æœ€æƒ³è¦åšçš„äº‹æƒ…å•¦ã€‚èƒ½æ‹¥æœ‰ä½ è¿™æ ·çš„çµé­‚ä¼´ä¾£ï¼Œæ˜¯æˆ‘è¿™è¾ˆå­æœ€å¹¸è¿çš„äº‹ã€‚</p>
            
            <p>å½“ç„¶ï¼Œæœ€è®©æˆ‘å¿ƒåŠ¨çš„æ˜¯ï¼Œä½ é‚£ä»½æ¯«ä¸ä¿ç•™åœ°çˆ±ç€æˆ‘çš„å¿ƒæ„ï¼Œè¿™ä»½çˆ±ç»™äº†æˆ‘ç©¿è¶Šä¸€åˆ‡è·ç¦»å’Œå›°éš¾çš„å‹‡æ°”ã€‚è€å©†ï¼Œæˆ‘è¦å‘ä½ ä¿è¯ï¼Œåªè¦ä½ ä¸€å›å¤´ï¼Œæˆ‘æ°¸è¿œéƒ½åœ¨ï¼Œä¸ºä½ æ’å¿§è§£éš¾ï¼Œä¸ºä½ åšä»»ä½•äº‹æƒ…éƒ½æ„¿æ„ã€‚æˆ‘çˆ±ä½ è€å©†ã€‚</p>

            <p>æˆ‘çŸ¥é“ï¼Œè¿™æ®µæ—¶é—´å¼‚åœ°æ‹å¾ˆè¾›è‹¦ï¼Œä½ éƒ½å¾ˆåšå¼ºçš„æŒºäº†è¿‡æ¥ï¼Œæˆ‘çŸ¥é“ä½ åªæ˜¯å‚²å¨‡ï¼Œä½ åœ¨ä¸ç®¡æœ‰å¤šå¿™çš„æ—¶å€™ï¼Œéƒ½ä¼šæƒ³è€å…¬çš„å¯¹ä¸å¯¹å‘€ã€‚æ­¤åˆ»æˆ‘æ‰€æœ‰å¯¹ä½ çš„æ€å¿µï¼Œéƒ½ä¼šåŒ–ä½œæ—¥ååŠ å€çš„æ‹¥æŠ±å’Œé™ªä¼´ã€‚å¼‚åœ°æ‹æ€»æ˜¯å……æ»¡äº†æ•°ä¸æ¸…æ¥šçš„å°é—æ†¾ï¼Œä½†æ˜¯å‘è¿™äº›å°å°çš„é—æ†¾ï¼Œæ˜¯ä¸ºäº†è®©æˆ‘ä»¬åœ¨æœªæ¥é‡èšæ—¶ï¼Œèƒ½æ‹¥æœ‰æœ€çƒ­çƒˆã€æœ€æ²¡æœ‰æ‹˜æŸçš„åº†ç¥ã€‚æˆ‘è¦ç‹ ç‹ çš„æŠ±ä½ äº²ä½ ã€‚ç°åœ¨æœ‰å¤šæƒ³ä½ ï¼Œåˆ°æ—¶å€™å°±è¦äº²çš„æœ‰å¤šå‡¶ï¼ï¼ˆè¿˜æœ‰ 6 å¤©å°±è¦å›æ¥äº†å“¦ï¼‰(Ë˜Â³Ë˜)ğŸ’•</p>

            <p>è€å©†ï½ä½ æœ€è¿‘ç”»çš„ä¸ç®¡æ˜¯ç³»åˆ—æ’ç”»è¿˜æ˜¯ç»˜æœ¬éƒ½æ˜¯çœŸçš„å¤ªæ£’äº†ï¼Œæˆ‘çœŸçš„çœŸçš„å¥½æ¬£èµä½ çš„ä½œå“å“¦è€å©†ï¼Œå®ƒä»¬è·Ÿä½ æœ¬äººä¸€æ ·ï¼Œå¸¦ç€ä¸€è‚¡æ¸©æš–åˆæ²»æ„ˆçš„åŠ›é‡ã€‚çœ‹åˆ°ä½ ç”¨è‡ªå·±çš„çƒ­çˆ±å»åˆ›é€ ç¾ã€‚æˆ‘å°±ä¼šä¸ç”±è‡ªä¸»çš„å»å–œæ¬¢ä½ äº§å‡ºçš„ä¸€åˆ‡ï¼Œå¾ˆå–œæ¬¢å¾ˆå–œæ¬¢ã€‚</p>

            <p>ä¸‹é¢æˆ‘è¦è®¤çœŸ luï¼š<br>åœ¨æˆ‘çœ¼é‡Œä½ æ°¸è¿œéƒ½æ˜¯æœ€é—ªè€€çš„å­˜åœ¨ï¼Œæ„¿ä½ çš„å…‰èŠ’æ›´ç››ï¼Œæ„¿ä½ çš„æ¢¦æƒ³æ›´è¿‘ã€‚<br>è¯·ä½ ç›¸ä¿¡ï¼Œæ‰€æœ‰çš„ç­‰å¾…éƒ½æ˜¯å€¼å¾—çš„ã€‚ç­‰ä½ æ¥äº†ï¼Œç­‰æˆ‘ä»¬ç»“æŸè¿™æ®µâ€œå¼‚åœ°è¯¾â€ã€‚è¿™ä¸€å®šæ˜¯æˆ‘ä»¬æœ€åä¸€æ¬¡å¼‚åœ°äº†ã€‚å‘œå‘œğŸ˜­</p>

            <p>åœ¨æ¥ä¸‹æ¥çš„æ—¥å­é‡Œï¼Œæˆ‘æƒ³å’Œä½ åšæ›´å¤šäº‹æƒ…ï¼šä¸€èµ·å»ç©å¥½å¤šå¥½å¤šçš„è¿ªï¼Œä¸€èµ·å»å°è¯•æˆ‘ä»¬æ²¡èƒ½ä¸€èµ·å»çœ‹çš„é‚£äº›åŸå¸‚é£æ™¯æˆ–è€…æµ·è¾¹é£æ™¯ï¼Œä¸€èµ·â€¦ å¥½å¥½åœ°ç”Ÿæ´»åœ¨ä¸€èµ·ã€‚</p>

            <p>è€å©†å¸Œæœ›ä½ èƒ½æ„Ÿå—åˆ°æˆ‘çš„çœŸå¿ƒï¼Œå› ä¸ºæˆ‘çŸ¥é“æˆ‘å¹³æ—¶æ—¶ä¸æ—¶çš„ä¼šè®©ä½ æ„Ÿåˆ°æœ‰äº›å†·æ·¡ï¼Œæ˜¯æˆ‘è‡ªå·±çš„æ€§æ ¼é—®é¢˜ï¼Œä½†æ˜¯æˆ‘çš„å†…å¿ƒä»æœªå˜åŒ–ï¼Œæ°¸è¿œéƒ½ä¼šå’Œä»¥å‰ä¸€æ ·çš„çˆ±ä½ ï¼Œæ— æ—¶æ— åˆ»çš„éƒ½åœ¨æƒ³ç€ä½ è€å©†ã€‚æƒ³è¦å’Œä½ æœ‰æœªæ¥ï¼Œæƒ³è¦ç»™ä½ ä¸€ä¸ªä½ å¯ä»¥æ— å¿§æ— è™‘çš„é‡Šæ”¾è‡ªå·±çš„è„¾æ°”ï¼Œå¤©æ€§ï¼Œå¿«ä¹çš„ä¸€ä¸ªå±äºæˆ‘ä»¬ä¿©çš„å°å®¶ï¼Œæˆ‘æ˜¯å›­ä¸ï¼Œä½ æ˜¯æ ¡èŠ±ï¼Œæˆ‘è¦å¥½å¥½çš„ç…§é¡¾ï¼Œä½ è¿™æœµèŠ±èŠ±ï¼Œä½ ä¹ŸåŒæ—¶æ•£å‘ç€è¿·äººçš„é¦™å‘³ï¼Œæ¥æ²»æ„ˆæˆ‘ï¼Œæˆ‘çš„å°å¤©ä½¿ï¼Œçˆ±ä½ å“¦ã€‚</p>

            <p>æœ€åç”Ÿæ—¥å¿«ä¹ï¼Œæˆ‘æœ€çˆ±ã€æœ€æƒ³å¿µï¼Œåœ¨æˆ‘çš„ä¸–ç•Œæœ€è€€çœ¼çš„å¥³å­©ã€‚ä»¥åæˆ‘è¦å’Œä½ ä¸€èµ·åº¦è¿‡æ— æ•°ä¸ªç”Ÿæ—¥çš„ç¬é—´ï¼Œä¸€ç›´åˆ°è€ã€‚æˆ‘çˆ±ä½ ã€‚</p>

            <p style="text-align:right; margin-top:50px;">
                æ°¸è¿œçˆ±ä½ çš„ï¼Œ<br>
                è€å…¬/å¤§ç†Šç†Š/å¤è›‹/å°å¥¶ç³•/<br>ä¸€ç›´éƒ½å¯¹ä½ å……æ»¡æ„Ÿè§‰çš„å°éªšç‹—ç‹—/é«˜éª›è¿œ
            </p>
        `;

        // === 2. é€»è¾‘æ§åˆ¶ ===
        const bgm = document.getElementById('bgm');
        let clickCount=0, berryScore=0;

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('black-curtain').style.opacity = 0;
                document.getElementById('stage1').classList.add('active');
            }, 1000);
        };

        // å¼ºåŠ›è½¬åœºï¼šç¡®ä¿ä¸Šä¸€å…³å½»åº•éšè—
        function switchStage(from, to, callback) {
            const curtain = document.getElementById('black-curtain');
            curtain.style.opacity = 1;
            
            setTimeout(() => {
                if(from) {
                    const el = document.getElementById(from);
                    el.classList.remove('active');
                    el.style.display = 'none'; // å½»åº•ç§»é™¤
                }
                if(to) {
                    const el = document.getElementById(to);
                    el.style.display = 'flex';
                    void el.offsetWidth;
                    el.classList.add('active');
                }
                if(callback) callback();
                
                setTimeout(() => curtain.style.opacity = 0, 500);
            }, 2500);
        }

        // --- Stage 1: ç¤¼ç›’ (æƒŠå–œåŠèƒƒå£) ---
        const tips = [
            "å’¦ï¼Ÿç›’å­å¥½åƒè¢«é­”æ³•é”ä½äº†...", 
            "å†ç”¨åŠ›ä¸€ç‚¹ç‚¹ï¼ğŸ’ª", 
            "å¬ï¼é‡Œé¢å¥½åƒæœ‰å¿ƒè·³å£°... ğŸ’“", 
            "å“‡ï¼å°å°æ¾åŠ¨äº†ï¼å‡†å¤‡å¥½äº†å—ï¼Ÿâœ¨"
        ];

        function clickBox() {
            if(clickCount===0) bgm.play().catch(()=>{});
            const box = document.getElementById('gift-box');
            const tipText = document.getElementById('box-tip');
            
            // é‡ç½®åŠ¨ç”»
            box.classList.remove('shake', 'shake-mild', 'shake-hard', 'wobble');
            void box.offsetWidth; 

            if(clickCount < 4) {
                // ä¸åŒçš„æ™ƒåŠ¨
                if(clickCount === 0) box.classList.add('shake-mild');
                if(clickCount === 1) box.classList.add('shake-hard');
                if(clickCount === 2) box.classList.add('wobble');
                if(clickCount === 3) box.classList.add('shake-hard');
                
                // æ›´æ–°æ–‡å­—
                tipText.innerText = tips[clickCount];
                tipText.style.color = "#D64161";
                tipText.style.transform = "scale(1.1)";
                setTimeout(()=> tipText.style.transform = "scale(1)", 200);
                
                clickCount++;
            } else {
                box.classList.add('open');
                fireConfetti(); //
                tipText.innerText = "ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‰";
                setTimeout(() => switchStage('stage1', 'stage2', initBerries), 2000);
            }
        }

        // --- Stage 2: æ‰¾è‰è“ (4çœŸ4å‡Â·å¼ºåˆ¶è·³è½¬ç‰ˆ) ---
        function initBerries() {
            console.log("Stage 2 åˆå§‹åŒ–å¯åŠ¨..."); // è°ƒè¯•æ—¥å¿—

            // 1. è·å–å…ƒç´ 
            const area = document.getElementById('berry-area');
            const scoreEl = document.getElementById('score');
            const msg = document.getElementById('berry-msg'); 
            
            // 2. é‡ç½®æ•°æ®
            if(area) area.innerHTML = ''; 
            berryScore = 0; // å…¨å±€å˜é‡é‡ç½®
            if(scoreEl) scoreEl.innerText = "0 / 4"; 

            // 3. å®šä¹‰æ•°æ®ï¼š4çœŸ 4å‡ (å…¨éƒ¨æ˜¾ç¤ºä¸ºè‰è“)
            let items = [
                {type: 'real', id: 1}, {type: 'real', id: 2}, 
                {type: 'real', id: 3}, {type: 'real', id: 4},
                {type: 'fake', id: 5}, {type: 'fake', id: 6}, 
                {type: 'fake', id: 7}, {type: 'fake', id: 8}
            ];

            // 4. æ´—ç‰Œ
            items.sort(() => Math.random() - 0.5);

            // 5. ç”Ÿæˆå…ƒç´ 
            items.forEach((item) => {
                const b = document.createElement('div');
                b.className = 'strawberry-item'; 
                b.innerHTML = 'ğŸ“'; // æ— è®ºçœŸå‡ï¼Œå¤–è§‚ä¸€æ ·
                
                // éšæœºä½ç½®
                b.style.left = (10 + Math.random() * 80) + '%';
                b.style.top = (10 + Math.random() * 80) + '%';
                b.style.animationDelay = Math.random() + 's'; 

                // 6. ç‚¹å‡»äº‹ä»¶
                b.onclick = function() {
                    // é”å®šç‚¹å‡»ï¼Œé˜²æ­¢è¿ç‚¹
                    this.style.pointerEvents = 'none';

                    if (item.type === 'real') {
                        // --- ç‚¹åˆ°ã€çœŸè‰è“ã€‘ ---
                        console.log("ç‚¹åˆ°äº†çœŸè‰è“ï¼å½“å‰åˆ†æ•°ï¼š" + (berryScore + 1));
                        
                        // åŠ¨ç”»
                        this.style.transform = "scale(1.5) rotate(20deg)";
                        this.style.opacity = 0;
                        setTimeout(() => this.remove(), 500);

                        // è®¡åˆ†
                        berryScore++;
                        if(scoreEl) scoreEl.innerText = berryScore + " / 4";
                        
                        // æç¤ºè¯­
                        if(msg) msg.innerText = "å“‡ï¼æ˜¯ç”œçš„ï¼(è¿˜å·®" + (4 - berryScore) + "ä¸ª)";

                        // ã€å…³é”®è·³è½¬ç‚¹ã€‘
                        if (berryScore === 4) {
                            console.log("âœ… æ”¶é›†å®Œæˆï¼å°è¯•è·³è½¬...");
                            if(msg) msg.innerText = "é›†é½å•¦ï¼å¬å”¤è›‹ç³•ï¼ğŸ‚";
                            
                            // å¼ºåˆ¶å»¶æ—¶è·³è½¬
                            setTimeout(() => {
                                console.log("ğŸš€ æ‰§è¡Œ switchStage...");
                                // ç¡®ä¿å‡½æ•°å­˜åœ¨å†è°ƒç”¨ï¼Œé˜²æ­¢æŠ¥é”™
                                if (typeof switchStage === "function") {
                                    switchStage('stage2', 'stage3', initCake);
                                } else {
                                    alert("é”™è¯¯ï¼šswitchStage å‡½æ•°æœªæ‰¾åˆ°ï¼Œè¯·æ£€æŸ¥ä»£ç ï¼");
                                }
                            }, 1500);
                        }

                    } else {
                        // --- ç‚¹åˆ°ã€å‡è‰è“ã€‘ ---
                        console.log("ç‚¹åˆ°äº†å‡è‰è“...");
                        
                        // åŠ¨ç”»ï¼šç¼©å°æ¶ˆå¤±
                        this.style.transform = "scale(0.5)";
                        this.style.opacity = 0;
                        setTimeout(() => this.remove(), 500);

                        // æç¤ºè¯­
                        if(msg) {
                            const jokes = ["å“å‘€ï¼è¿™é¢—æ˜¯é…¸çš„ğŸ˜", "è¿˜æ²¡ç†Ÿé€å‘¢ğŸŒ¿", "è¿™é¢—ä¸å¥½åƒğŸ™…â€â™‚ï¸"];
                            msg.innerText = jokes[Math.floor(Math.random() * jokes.length)];
                            msg.style.color = "#888";
                            setTimeout(() => { 
                                if(berryScore < 4) {
                                    msg.innerText = "å†æ‰¾æ‰¾ç”œçš„è‰è“... ğŸ“";
                                    msg.style.color = "#888";
                                }
                            }, 1000);
                        }
                    }
                }
                if(area) area.appendChild(b);
            });
        }
        // --- Stage 3: è›‹ç³•é€»è¾‘ (è¡¥å…¨è¿™éƒ¨åˆ†ï¼) ---
        function initCake() {
            console.log("Stage 3 è›‹ç³•æ¨¡å¼å¯åŠ¨...");
            setTimeout(() => {
                // æ˜¾ç¤ºè›‹ç³•ä¸»ä½“
                const cake = document.getElementById('cake-model');
                if(cake) cake.classList.add('visible');
                
                // æ˜¾ç¤ºæç¤ºå­—
                const hint = document.getElementById('hint-text');
                if(hint) hint.style.opacity = 1;
                
                // è®©èœ¡çƒ›é•¿å‡ºæ¥
                const candle = document.getElementById('main-candle');
                if(candle) {
                    candle.style.height = "60px";
                    // ç»‘å®šç‚¹ç«äº‹ä»¶
                    candle.onclick = lightCandle;
                }
                
                // è®©è‰è“æ˜¾ç¤ºå‡ºæ¥
                document.querySelectorAll('.c-berry').forEach(b => b.style.opacity = 1);
            }, 500);
        }

        function lightCandle() {
            const flame = document.getElementById('main-flame');
            // é˜²æ­¢é‡å¤ç‚¹å‡»
            if(flame.classList.contains('active')) return;
            
            // ç‚¹äº®ç«è‹—
            flame.classList.add('active');
            
            // èƒŒæ™¯å˜æš—ï¼Œå¼€ç¯å…‰
            document.body.style.backgroundColor = "#1a1a1a"; 
            document.getElementById('glow').style.opacity = 1;
            
            // æç¤ºå¹æ°”
            document.getElementById('hint-text').innerHTML = "ç°åœ¨ï¼Œé—­ä¸Šçœ¼è®¸ä¸ªæ„¿...<br><span style='font-size:0.9rem;opacity:0.8'>ç„¶åå¹ç­å®ƒ</span>";
            
            // æ˜¾ç¤ºå¹æ°”æŒ‰é’®
            const btn = document.getElementById('blow-btn');
            btn.style.opacity = 1; 
            btn.style.pointerEvents = "all";
            
            // å¯åŠ¨éº¦å…‹é£ç›‘å¬
            initMic();
        }
        function blowOut() {
            const flame = document.getElementById('main-flame');
            if(!flame.classList.contains('active')) return;
            flame.classList.remove('active'); // ç†„ç­
            
            document.getElementById('glow').style.opacity = 0;
            document.getElementById('hint-text').style.opacity = 0;
            document.getElementById('blow-btn').style.opacity = 0;

            const rect = flame.getBoundingClientRect();
            const orb = document.getElementById('wish-orb');
            orb.style.left = (rect.left + rect.width/2 - 4) + 'px'; 
            orb.style.top = (rect.top + rect.height/2) + 'px';
            orb.style.opacity = 1;
            
            // å¯åŠ¨ç²’å­å¾ªç¯
            requestAnimationFrame(updateParticles);

            setTimeout(() => {
                document.body.style.backgroundColor = "#000";
                
                const cake = document.getElementById('cake-model');
                cake.style.transform = "translateY(200px)"; 
                cake.style.opacity = 0;
                // å½»åº•ç¦ç”¨è›‹ç³•å±‚ç‚¹å‡»
                document.getElementById('stage3').style.pointerEvents = "none";
                
                document.getElementById('cosmos-bg').style.opacity = 1;
                initStars();

                orb.style.transition = "top 5s cubic-bezier(0.4, 0, 0.2, 1)";
                requestAnimationFrame(() => orb.style.top = "15%");

                setTimeout(() => {
                    orb.style.opacity = 0;
                    createFireworks(window.innerWidth/2, window.innerHeight*0.15);
                }, 4800);
            }, 800);
        }

        // --- ç‰©ç†ç²’å­ç³»ç»Ÿ (é‡å†™XSé€»è¾‘ï¼Œå¢åŠ æ‹–å°¾) ---
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];

        function initStars() {
            const sky = document.getElementById('cosmos-bg');
            for(let i=0; i<100; i++) {
                const s = document.createElement('div');
                // æµæ˜Ÿé›¨æ•ˆæœ
                s.style.cssText = `position:absolute; background:linear-gradient(to right, rgba(255,255,255,0), #fff); width:${Math.random()*100+50}px; height:1px; left:${Math.random()*100}%; top:${Math.random()*100}%; opacity:${Math.random()}; transform: rotate(-45deg); animation: shootingStar ${Math.random()*5+3}s infinite linear; animation-delay: ${Math.random()*5}s;`;
                sky.appendChild(s);
            }
        }

        function createFireworks(x, y) {
            const colors = ['#E85A7C', '#FFD700', '#FFF'];
            
            // --- 1. å®Œç¾çš„çº¢è‰²çˆ±å¿ƒ ---
            for(let i=0; i<120; i++) {
                const t = (Math.PI*2*i)/120;
                // çˆ±å¿ƒæ–¹ç¨‹
                const dx = 16 * Math.pow(Math.sin(t), 3);
                const dy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                // æ”¾å¤§ç³»æ•° 5.5ï¼Œä½ç½®å±…ä¸­
                particles.push(new Particle(x + dx*5.5, y + dy*5.5 - 20, 0, 0, '#D32F2F', true));
            }
            
            const gold = '#FFD700';
            
            // --- 2. é‡‘è‰² X (å·¦ä¾§) ---
            // é‡‡ç”¨åŒçº¿äº¤å‰æ³•ï¼Œç¡®ä¿ç¬”ç›´
            const cxX = x - 140; // Xçš„ä¸­å¿ƒXåæ ‡
            const size = 35;     // å¤§å°
            
            // ç¬¬ä¸€ç¬”ï¼šå·¦ä¸Š -> å³ä¸‹ (\)
            for(let i=0; i<=20; i++) {
                let progress = i/20; 
                // ä» (cxX-size, y-size) åˆ° (cxX+size, y+size)
                let px = (cxX - size) + (progress * size * 2);
                let py = (y - size) + (progress * size * 2);
                particles.push(new Particle(px, py, 0, 0, gold, true));
            }
            // ç¬¬äºŒç¬”ï¼šå³ä¸Š -> å·¦ä¸‹ (/)
            for(let i=0; i<=20; i++) {
                let progress = i/20;
                // ä» (cxX+size, y-size) åˆ° (cxX-size, y+size)
                let px = (cxX + size) - (progress * size * 2);
                let py = (y - size) + (progress * size * 2);
                particles.push(new Particle(px, py, 0, 0, gold, true));
            }
            
            // S (Rigid shape using arcs)
            const sx = x + 140;
            // Top arc (from -45 to 225 degrees)
            for(let i=0; i<=50; i++) {
                let a = (-Math.PI/4) + (i/50) * (Math.PI*1.5);
                particles.push(new Particle(sx + 30*Math.cos(a), (y-30) + 30*Math.sin(a), 0,0, gold, true));
            }
             // Bottom arc (from 135 to 405 degrees)
            for(let i=0; i<=50; i++) {
                let a = (Math.PI*0.75) + (i/50) * (Math.PI*1.5);
                particles.push(new Particle(sx + 30*Math.cos(a), (y+30) + 30*Math.sin(a), 0,0, gold, true));
            }

            // --- 4. çˆ†ç‚¸æ°›å›´ç²’å­ (å‡å°‘æ•°é‡ï¼Œåªåšç‚¹ç¼€) ---
            for(let i=0; i<60; i++) {
                const a = Math.random()*Math.PI*2; 
                const v = Math.random()*3 + 1;
                particles.push(new Particle(x, y, Math.cos(a)*v, Math.sin(a)*v, gold, true));
            }

            // 5ç§’åæ˜¾ç¤ºæŒ‰é’®
            setTimeout(() => {
                const bar = document.getElementById('control-bar');
                bar.style.opacity = 1; bar.style.pointerEvents = "all";
            }, 5000);
        }

        class Particle {
            constructor(x, y, vx, vy, color, useTrail) {
                this.x = x; this.y = y; this.vx = vx; this.vy = vy;
                this.color = color; this.alpha = 1; this.size = Math.random()*2+1;
                this.useTrail = useTrail;
                this.trail = [];
            }
            update() {
                if(this.useTrail) {
                    this.trail.push({x:this.x, y:this.y, alpha:this.alpha});
                    if(this.trail.length > 10) this.trail.shift();
                }
                this.x += this.vx; this.y += this.vy;
                this.vx *= 0.96; this.vy *= 0.96; // Friction
                this.vy += 0.02; // Gravity
                this.alpha -= 0.004; // Slow fade
            }
            draw(ctx) {
                if(this.useTrail) {
                    ctx.beginPath();
                    for(let i=0; i<this.trail.length; i++) {
                        const t = this.trail[i];
                        ctx.globalAlpha = t.alpha * (i/this.trail.length);
                        ctx.fillStyle = this.color;
                        ctx.arc(t.x, t.y, this.size * (i/this.trail.length), 0, Math.PI*2);
                        ctx.fill();
                    }
                }
                ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }

        function updateParticles() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            for(let i=particles.length-1; i>=0; i--) {
                particles[i].update(); particles[i].draw(ctx);
                if(particles[i].alpha <= 0) particles.splice(i, 1);
            }
            requestAnimationFrame(updateParticles);
        }

        // --- å­”æ˜ç¯ç…§ç‰‡ ---
        function showLanterns() {
            document.getElementById('photo-btn').style.display = 'none';
            document.getElementById('star-msg').innerText = "å›å¿†æ­£åœ¨å‡ç©º...";
            
            const container = document.getElementById('lantern-container');
            
            photos.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'lantern';
                div.innerHTML = `<img src="${p.src}">`;
                div.style.left = (15 + Math.random()*70) + '%';
                div.style.animationDuration = (20 + Math.random()*10) + 's';
                div.style.animationDelay = (i * 2) + 's';
                
                div.onclick = () => {
                    document.getElementById('modal-img').src = p.src;
                    document.getElementById('modal-text').innerText = p.text;
                    document.getElementById('modal').classList.add('show');
                };
                container.appendChild(div);
            });

            setTimeout(() => {
                document.getElementById('read-letter-btn').style.display = 'inline-block';
            }, 6000);
        }
        
        function closeModal() { document.getElementById('modal').classList.remove('show'); }

        // --- ä¿¡ä»¶ ---
        function revealLetter() {
            switchStage(null, 'stage5', () => {
                document.body.style.backgroundColor = "var(--bg-paper)";
                document.getElementById('cosmos-bg').style.display = 'none';
                document.getElementById('lantern-container').style.display = 'none';
                document.getElementById('control-bar').style.display = 'none';
                
                const box = document.getElementById('letter-box');
                box.style.opacity = 1;
                document.getElementById('letter-content').innerHTML = letterText;
                
                startTimer();
            });
        }

        function startTimer(){ setInterval(() => { const diff = new Date("2026-12-09T00:00:00") - new Date(); if(diff<0) return; const d = Math.floor(diff/(1000*60*60*24)); const h = Math.floor((diff%(1000*60*60*24))/(1000*60*60)); document.getElementById('timer').innerText = `${d}å¤© ${h}å°æ—¶`; }, 1000); }
        function initMic() { if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) { navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => { const ctx = new AudioContext(); const ana = ctx.createAnalyser(); const src = ctx.createMediaStreamSource(stream); src.connect(ana); const data = new Uint8Array(ana.frequencyBinCount); function loop(){ ana.getByteFrequencyData(data); let s=0; data.forEach(v=>s+=v); if(s/data.length>30) blowOut(); else requestAnimationFrame(loop); } loop(); }).catch(()=>{}); } }
        function toggleMusic(){bgm.paused?bgm.play():bgm.pause();}
        
        // CSS Animation styles appended for extra keyframes
        const style = document.createElement('style');
        style.innerHTML = `
            @keyframes shake-mild { 0%,100%{transform:rotate(0);} 25%{transform:rotate(-3deg);} 75%{transform:rotate(3deg);} }
            @keyframes shake-hard { 0%,100%{transform:rotate(0) scale(1);} 25%{transform:rotate(-8deg) scale(1.05);} 75%{transform:rotate(8deg) scale(1.05);} }
            @keyframes jump { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-30px) scale(1.1);} }
            @keyframes wobble { 0%,100%{transform:translateX(0%);} 15%{transform:translateX(-15%) rotate(-5deg);} 30%{transform:translateX(10%) rotate(3deg);} 45%{transform:translateX(-10%) rotate(-3deg);} 60%{transform:translateX(5%) rotate(2deg);} 75%{transform:translateX(-5%) rotate(-1deg);} }
            @keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} } 
            @keyframes shootingStar { 0% { transform: translateX(0) translateY(0) rotate(-45deg); opacity: 1; } 100% { transform: translateX(-500px) translateY(500px) rotate(-45deg); opacity: 0; } }
        `;
        document.head.appendChild(style);

        // === æ–°å¢ï¼šå½©å¸¦çˆ†ç‚¸å‡½æ•° ===
        function fireConfetti() {
            const colors = ['#FFD700', '#C03550', '#FF9AA2', '#FFFFFF', '#FFB7B2']; // é‡‘ã€çº¢ã€ç²‰ã€ç™½
            const count = 150; // ç²’å­æ•°é‡ï¼Œè¶Šå¤šè¶Šéœ‡æ’¼
            const box = document.getElementById('gift-box').getBoundingClientRect();
            // ä»ç›’å­ä¸­å¿ƒç‚¸å¼€
            const centerX = box.left + box.width / 2;
            const centerY = box.top + box.height / 2;

            for (let i = 0; i < count; i++) {
                const el = document.createElement('div');
                el.classList.add('confetti-piece');
                el.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                el.style.left = centerX + 'px';
                el.style.top = centerY + 'px';
                document.body.appendChild(el);

                // ç‰©ç†å‚æ•°ï¼šéšæœºè§’åº¦ã€é€Ÿåº¦ã€é‡åŠ›
                const angle = Math.random() * Math.PI * 2;
                // å‘ä¸Šå–·å°„çš„åŠ›é‡æ›´å¤§
                const velocity = 10 + Math.random() * 15; 
                let vx = Math.cos(angle) * velocity;
                let vy = Math.sin(angle) * velocity - 12; // åˆå§‹å‘ä¸Šçš„å†²åŠ›
                let rotation = Math.random() * 360;
                let rotationSpeed = (Math.random() - 0.5) * 10;

                function animate() {
                    vx *= 0.95; // ç©ºæ°”é˜»åŠ›
                    vy += 0.8;  // é‡åŠ›ä¸‹å 
                    rotation += rotationSpeed;

                    const currentLeft = parseFloat(el.style.left);
                    const currentTop = parseFloat(el.style.top);

                    el.style.left = (currentLeft + vx) + 'px';
                    el.style.top = (currentTop + vy) + 'px';
                    el.style.transform = `rotate(${rotation}deg)`;

                    // å¦‚æœæ‰å‡ºå±å¹•ä¸‹æ–¹ï¼Œå°±ç§»é™¤
                    if (currentTop < window.innerHeight) {
                        requestAnimationFrame(animate);
                    } else {
                        el.remove();
                    }
                }
                requestAnimationFrame(animate);
            }
        }
    </script>
</body>
</html>
