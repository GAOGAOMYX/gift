<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è‡´æˆ‘æœ€çˆ±çš„è€å©† â¤ï¸</title>
    <style>
        /* å¼•å…¥ Google Fonts é«˜çº§è¡¬çº¿ä½“ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;600;700&display=swap');

        :root {
            /* è°ƒè‰²æ¿ */
            --bg-paper: #F9F4E8; /* ç¾Šçš®çº¸è‰² */
            --night-sky: #090910; /* æ·±ç©º */
            --text-primary: #3E2723; /* æ·±è¤ */
            --accent-red: #D32F2F;
            --gold: #FFD700;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Noto Serif SC', serif;
            background-color: var(--bg-paper);
            color: var(--text-primary);
            height: 100vh; width: 100vw;
            overflow: hidden;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            transition: background-color 3s ease-in-out;
        }

        /* --- 1. å…¨å±€ç‰¹æ•ˆå±‚ --- */
        
        /* èƒ¶ç‰‡å™ªç‚¹æ»¤é•œ (å¢åŠ ç”µå½±è´¨æ„Ÿ) */
        .film-grain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
            pointer-events: none; z-index: 9998; mix-blend-mode: overlay;
        }

        /* é»‘åœºè½¬åœº (æœ€é«˜å±‚çº§) */
        #black-curtain {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 10000;
            opacity: 1; pointer-events: none;
            transition: opacity 2.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* ç²’å­ç”»å¸ƒ (çƒŸèŠ±ã€æµæ˜Ÿ) - å±‚çº§æå‡ä»¥ç¡®ä¿è§†è§‰æ•ˆæœ */
        #particle-canvas {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 6000;
        }

        /* --- 2. èˆå°ç®¡ç† --- */
        .stage {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; transition: opacity 1.5s ease;
            z-index: 10;
        }
        .stage.active { display: flex; opacity: 1; }

        /* --- Stage 1: ç¤¼ç›’ --- */
        .box-container {
            position: relative; width: 220px; height: 220px;
            cursor: pointer; margin-top: 50px;
            perspective: 1000px;
        }
        .box-body {
            position: absolute; bottom: 0; width: 100%; height: 75%;
            background: linear-gradient(135deg, #C03550, #8B0000);
            border-radius: 6px;
            box-shadow: 0 30px 60px rgba(0,0,0,0.3);
        }
        .box-lid {
            position: absolute; top: 10%; left: -5%; width: 110%; height: 25%;
            background: linear-gradient(135deg, #E85A7C, #C03550);
            border-radius: 4px; z-index: 2;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 1.2s cubic-bezier(0.34, 1.56, 0.64, 1);
            transform-origin: top center;
        }
        .ribbon {
            position: absolute; left: 50%; transform: translateX(-50%); width: 25px; height: 100%;
            background: linear-gradient(to right, #FFD700, #FDB931);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .box-bow {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%);
            width: 70px; height: 35px;
            background: radial-gradient(circle at center, #FFD700, #FDB931);
            border-radius: 50%;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .shake { animation: shake-anim 0.5s ease-in-out; }
        .open .box-lid { transform: rotateX(120deg) translateY(-150px) scale(0.9); opacity: 0; }
        
        @keyframes shake-anim { 0%,100%{transform:rotate(0);} 25%{transform:rotate(-3deg);} 75%{transform:rotate(3deg);} }

        /* --- Stage 2: è‰è“ --- */
        .strawberry-item {
            position: absolute; font-size: 3.5rem; 
            filter: drop-shadow(0 15px 15px rgba(0,0,0,0.2));
            cursor: pointer; transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            animation: float 3s ease-in-out infinite;
            z-index: 100;
        }
        .strawberry-item:active { transform: scale(1.4) rotate(15deg); }

        /* --- Stage 3: è›‹ç³•ä¸è®¸æ„¿ --- */
        .cake-stage-wrapper {
            position: relative; width: 320px; height: 320px;
            display: flex; justify-content: center; align-items: flex-end;
            margin-bottom: 60px;
            opacity: 0; transform: translateY(50px);
            transition: opacity 1.5s, transform 1.5s;
        }
        .cake-stage-wrapper.visible { opacity: 1; transform: translateY(0); }

        /* è›‹ç³•ä¸»ä½“ */
        .c-layer {
            position: absolute; bottom: 0; width: 240px; height: 100px;
            background: linear-gradient(to right, #fff, #f0f0f0);
            border-radius: 12px;
            box-shadow: inset 0 -10px 20px rgba(0,0,0,0.05), 0 20px 40px rgba(0,0,0,0.1);
        }
        .c-layer.top { bottom: 95px; width: 220px; height: 90px; z-index: 2; background: #FFF0F5; }
        
        /* å¥¶æ²¹æ·‹é¢ */
        .c-icing {
            position: absolute; bottom: 175px; width: 230px; height: 30px;
            background: #fff; border-radius: 20px; z-index: 3;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* è‰è“è£…é¥° (Z-Index = 10, é«˜äºèœ¡çƒ›åº•éƒ¨) */
        .c-berry {
            position: absolute; bottom: 180px; font-size: 2rem; z-index: 10;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.15));
            opacity: 0; transform: translateY(-30px); transition: all 0.8s;
        }
        .c-berry.p1 { left: 50px; bottom: 150px}
        .c-berry.p2 { left: 110px; bottom: 150px}
        .c-berry.p3 { left: 170px; bottom: 150px}
        .c-berry.p4 { left: 230px; bottom: 150px}

        /* èœ¡çƒ›ä¸»ä½“ (Z-Index = 20, ç¡®ä¿å¯ç‚¹å‡») */
        .c-candle {
            position: absolute; bottom: 180px; left: 50%; transform: translateX(-50%);
            width: 16px; height: 0; /* åˆå§‹0 */
            background: repeating-linear-gradient(45deg, #fff, #fff 5px, #f0f0f0 5px, #f0f0f0 10px);
            z-index: 20; border-radius: 4px; 
            transition: height 1s ease;
            cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* ç«è‹— (åˆå§‹å¿…é¡»å®Œå…¨éšè—) */
        .c-flame {
            position: absolute; top: -18px; left: 50%; transform: translateX(-50%) scale(0);
            width: 18px; height: 40px;
            background: radial-gradient(ellipse at bottom, #fff 10%, #FFD700 40%, #FF4500 100%);
            border-radius: 50% 50% 20% 20%;
            filter: blur(1px); opacity: 0;
            transition: all 0.5s; pointer-events: none;
            transform-origin: bottom center;
        }
        /* æ¿€æ´»çŠ¶æ€ */
        .c-flame.active { 
            opacity: 1 !important; 
            transform: translateX(-50%) scale(1) !important; 
            animation: flicker 1.2s infinite alternate; 
        }

        /* å‘¼å¸å…‰æ™• */
        .ambient-glow {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, rgba(255, 140, 0, 0.15), transparent 70%);
            opacity: 0; pointer-events: none; transition: opacity 2s; z-index: 1;
        }

        /* æ„¿æœ›çƒ (ç‹¬ç«‹å±‚çº§) */
        #wish-orb {
            position: fixed; width: 8px; height: 8px;
            background: #fff; border-radius: 50%;
            box-shadow: 0 0 20px #fff, 0 0 50px #FFD700;
            z-index: 7000; opacity: 0; pointer-events: none;
        }

        /* --- Stage 4: å®‡å®™ --- */
        #cosmos-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--night-sky); z-index: -1;
            opacity: 0; transition: opacity 4s;
        }
        
        /* å­”æ˜ç¯å®¹å™¨ */
        #lantern-container {
            position: fixed; top:0; left:0; width:100%; height:100%;
            pointer-events: none; z-index: 100;
            perspective: 1000px;
        }
        .lantern {
            position: absolute; width: 140px; height: 200px;
            background: #fff; padding: 10px 10px 40px 10px;
            /* æš–å…‰é˜´å½± */
            box-shadow: 0 0 40px rgba(255, 200, 100, 0.2), inset 0 0 30px rgba(255, 180, 50, 0.1);
            bottom: -300px; cursor: pointer; pointer-events: auto;
            transform-style: preserve-3d;
            animation: riseSway linear infinite;
        }
        .lantern img { width: 100%; height: 100%; object-fit: cover; filter: sepia(40%) contrast(1.1); }
        .lantern:hover { 
            transform: scale(1.15) !important; z-index: 500; 
            box-shadow: 0 0 60px rgba(255, 200, 100, 0.6); 
            transition: transform 0.3s;
        }

        /* æŒ‰é’®æ§åˆ¶æ  */
        #control-bar {
            position: fixed; bottom: 10%; width: 100%; text-align: center;
            opacity: 0; transition: opacity 2s; z-index: 8000;
            pointer-events: none;
        }
        .elegant-btn {
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.3);
            color: rgba(255,255,255,0.9); padding: 14px 45px; border-radius: 50px;
            font-size: 1.1rem; font-family: 'Noto Serif SC', serif; letter-spacing: 3px;
            cursor: pointer; backdrop-filter: blur(10px); transition: all 0.3s;
            pointer-events: auto; box-shadow: 0 0 20px rgba(255,255,255,0.1);
        }
        .elegant-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.05); }

        /* æ¨¡æ€æ¡† */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); z-index: 9000;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            opacity: 0; pointer-events: none; transition: opacity 0.5s;
        }
        .modal.show { opacity: 1; pointer-events: all; }
        .modal img { max-width: 85vw; max-height: 60vh; border: 6px solid #fff; border-radius: 4px; box-shadow: 0 0 50px rgba(0,0,0,0.5); }
        .modal p { color: #ddd; margin-top: 25px; font-size: 1.2rem; letter-spacing: 1px; }

        /* --- Stage 5: ä¿¡ä»¶ --- */
        .letter-scroll {
            width: 85%; max-width: 650px; height: 75vh;
            background: #fffdf7; 
            color: #2c2c2c; padding: 50px 40px; border-radius: 4px;
            box-shadow: 0 0 80px rgba(0,0,0,0.3);
            overflow-y: auto; line-height: 2.2; font-size: 1.15rem;
            position: relative; opacity: 0; transition: opacity 2s;
        }
        /* ä¿¡çº¸çº¹ç† */
        .letter-scroll::before {
            content: ""; position: absolute; top:0; left:0; width:100%; height:100%;
            background-image: linear-gradient(#e0e0e0 1px, transparent 1px);
            background-size: 100% 2.2em; pointer-events: none; opacity: 0.4;
        }

        /* åŠ¨ç”»å®šä¹‰ */
        @keyframes float { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-15px);} }
        @keyframes flicker { 
            0%,100%{opacity:1; transform:translateX(-50%) scale(1);} 
            50%{opacity:0.85; transform:translateX(-50%) scale(0.95);} 
        }
        @keyframes riseSway {
            0% { bottom: -300px; transform: translateX(0) rotate(0deg); }
            20% { transform: translateX(20px) rotate(2deg); }
            50% { transform: translateX(-20px) rotate(-1deg); }
            80% { transform: translateX(10px) rotate(1deg); }
            100% { bottom: 120vh; transform: translateX(0) rotate(0deg); }
        }
    </style>
</head>
<body>

    <audio id="bgm" loop><source src="music.mp3" type="audio/mpeg"></audio>
    <div onclick="toggleMusic()" style="position:fixed; top:25px; right:25px; z-index:10001; opacity:0.5; color:#888; cursor:pointer;">ğŸµ</div>

    <div id="black-curtain"></div>
    <canvas id="fireworks-canvas"></canvas>

    <div class="stage active" id="stage1">
        <h1 style="font-size:2rem; margin-bottom:50px; color:var(--accent-red); font-weight:normal; letter-spacing:2px; opacity:0; animation: fadeIn 2s forwards 1s;">äº²çˆ±çš„ï¼Œç”Ÿæ—¥å¿«ä¹</h1>
        <div class="box-container" id="gift-box" onclick="clickBox()">
            <div class="box-lid"><div class="ribbon"></div><div class="box-bow"></div></div>
            <div class="box-body"><div class="ribbon"></div></div>
        </div>
        <p style="margin-top:50px; color:#999; letter-spacing:1px; opacity:0; animation: fadeIn 2s forwards 1.5s;">( è½»è§¦å¼€å¯ç¤¼ç‰© )</p>
    </div>

    <div class="stage" id="stage2">
        <h2 style="color:#555; font-weight:normal;">å¥½åƒå°‘äº†ç‚¹ä»€ä¹ˆ...</h2>
        <p style="color:#888; margin-bottom:40px;">æ”¶é›† 5 é¢—è‰è“è£…é¥°è›‹ç³• ğŸ“</p>
        <div style="width:100%; height:60vh; position:relative;" id="berry-area"></div>
        <div id="score" style="color:var(--accent-red); font-size:1.5rem;">0 / 5</div>
    </div>

    <div class="stage" id="stage3">
        <div class="ambient-glow" id="glow"></div>
        <div class="cake-stage-wrapper" id="cake-model">
            <div class="c-layer"></div>
            <div class="c-layer top"></div>
            <div class="c-icing"></div>
            <div class="c-berry p1">ğŸ“</div>
            <div class="c-berry p2">ğŸ“</div>
            <div class="c-berry p3">ğŸ“</div>
            <div class="c-berry p4">ğŸ“</div>
            <div class="c-candle" id="main-candle">
                <div class="c-flame" id="main-flame"></div>
            </div>
        </div>
        
        <div id="hint-text" style="text-align:center; color:#C03550; font-size:1.2rem; opacity:0; transition:opacity 1s; z-index:20;">
            è›‹ç³•åšå¥½å•¦<br><span style="font-size:0.9rem; color:#888;">ç‚¹å‡»èœ¡çƒ›ç‚¹äº®å®ƒ ğŸ•¯ï¸</span>
        </div>
        
        <div id="blow-btn" style="margin-top:30px; opacity:0; transition:opacity 1s; pointer-events:none; z-index:20;">
            <button onclick="blowOut()" class="elegant-btn" style="color:#C03550; border-color:rgba(192, 53, 80, 0.3); background:rgba(255,255,255,0.6);">
                ğŸ’¨ å¹ç­è®¸æ„¿
            </button>
        </div>
    </div>

    <div id="wish-orb"></div>

    <div id="cosmos-bg"></div>
    <div id="lantern-container"></div>
    
    <div id="control-bar">
        <p id="star-msg" style="color:rgba(255,255,255,0.7); margin-bottom:25px; letter-spacing:2px;">æ„¿æœ›å·²åŒ–ä½œæ¼«å¤©æ˜Ÿè¾°</p>
        <button id="photo-btn" class="elegant-btn" onclick="showLanterns()">âœ¨ ç‚¹å‡»æ¼‚æµ®çš„å›å¿† âœ¨</button>
        <button id="read-letter-btn" class="elegant-btn" style="display:none;" onclick="revealLetter()">äº²å¯ä¿¡ä»¶ ğŸ’Œ</button>
    </div>

    <div class="modal" id="modal" onclick="closeModal()">
        <img id="modal-img" src="">
        <p id="modal-text"></p>
        <p style="color:#aaa; font-size:0.8rem; margin-top:30px;">( ç‚¹å‡»èƒŒæ™¯å…³é—­ )</p>
    </div>

    <div class="stage" id="stage5">
        <div class="letter-scroll" id="letter-box">
            <h2 style="text-align:center; color:var(--accent-red); margin-bottom:30px;">è‡´ æˆ‘æœ€çˆ±çš„è€å©†</h2>
            <div id="letter-content"></div>
            <hr style="margin:40px 0; border:0; border-top:1px dashed #ccc;">
            <div style="text-align:center; color:#888; font-size:0.9rem;">
                è·ç¦»ä¸‹ä¸€æ¬¡ç”Ÿæ—¥è¿˜æœ‰ï¼š<br>
                <span id="timer" style="color:var(--accent-red); font-weight:bold;">è®¡ç®—ä¸­...</span>
            </div>
        </div>
    </div>

    <script>
        // === 1. æ•°æ®é…ç½® ===
        const photos = [
            {src:"img1.jpg", text:"åˆæ¬¡ç›¸é‡"},
            {src:"img2.jpg", text:"ä½ ç¬‘èµ·æ¥çœŸå¥½çœ‹"},
            {src:"img3.jpg", text:"æ—…è¡Œçš„æ„ä¹‰"},
            {src:"img1.jpg", text:"å¹³å‡¡çš„å¹¸ç¦"},
            {src:"img2.jpg", text:"ç”Ÿæ—¥å¿«ä¹"}
        ];

        const letterText = `
            <p>äº²çˆ±çš„è€å©†ï¼š</p>
            <p>ç”Ÿæ—¥å¿«ä¹ï¼</p>
            <p>ä»Šå¤©æ˜¯ä½ ç‰¹åˆ«çš„æ—¥å­ã€‚æˆ‘æƒ³æŠŠå¤©ä¸Šçš„æ˜Ÿæ˜Ÿã€æœ€å¥½åƒçš„è›‹ç³•ã€è¿˜æœ‰æˆ‘ä»¬æ‰€æœ‰çš„ç¾å¥½å›å¿†éƒ½é€ç»™ä½ ã€‚</p>
            <p>åˆšæ‰é‚£é¢—å‡èµ·çš„æ„¿æœ›çƒï¼Œä»£è¡¨ç€æˆ‘ä¼šæ°¸è¿œå®ˆæŠ¤ä½ çš„æ¢¦æƒ³ã€‚æ¼«å¤©çš„çƒŸèŠ±ï¼Œæ˜¯æˆ‘ä¸ºä½ è®¸ä¸‹çš„å¿ƒæ„¿ã€‚</p>
            <p>è°¢è°¢ä½ å‡ºç°åœ¨æˆ‘çš„ç”Ÿå‘½é‡Œï¼Œè®©å¹³æ·¡çš„æ—¥å­å˜å¾—é—ªé—ªå‘å…‰ã€‚</p>
            <p>æ— è®ºæœªæ¥å¦‚ä½•ï¼Œæˆ‘éƒ½ä¼šä¸€ç›´ç‰µç€ä½ çš„æ‰‹ï¼Œé™ªä½ èµ°è¿‡æ¯ä¸€ä¸ªæ˜¥å¤ç§‹å†¬ã€‚</p>
            <p>æˆ‘çˆ±ä½ ï¼Œä¸æ­¢ä»Šå¤©ï¼Œè€Œæ˜¯æ°¸è¿œã€‚</p>
            <p style="text-align:right; margin-top:40px;">â€”â€” çˆ±ä½ çš„è€å…¬</p>
        `;

        // === 2. é€»è¾‘æ§åˆ¶ ===
        const bgm = document.getElementById('bgm');
        let clickCount=0, berryScore=0;

        window.onload = () => {
            setTimeout(() => {
                document.getElementById('black-curtain').style.opacity = 0;
                document.getElementById('stage1').classList.add('active');
            }, 1000);
        };

        // å¼ºåŠ›è½¬åœºï¼šç¡®ä¿ä¸Šä¸€å…³å½»åº•éšè—
        function switchStage(from, to, callback) {
            const curtain = document.getElementById('black-curtain');
            curtain.style.opacity = 1;
            
            setTimeout(() => {
                if(from) {
                    const el = document.getElementById(from);
                    el.classList.remove('active');
                    el.style.display = 'none'; // å½»åº•ç§»é™¤
                }
                if(to) {
                    const el = document.getElementById(to);
                    el.style.display = 'flex';
                    void el.offsetWidth;
                    el.classList.add('active');
                }
                if(callback) callback();
                
                setTimeout(() => curtain.style.opacity = 0, 500);
            }, 2500);
        }

        // --- Stage 1 ---
        function clickBox() {
            if(clickCount===0) bgm.play().catch(()=>{});
            const box = document.getElementById('gift-box');
            clickCount++;
            box.classList.remove('shake'); void box.offsetWidth; box.classList.add('shake');
            
            if(clickCount === 4) {
                box.classList.add('open');
                setTimeout(() => switchStage('stage1', 'stage2', initBerries), 2000);
            }
        }

        // --- Stage 2 ---
        function initBerries() {
            const area = document.getElementById('berry-area');
            const score = document.getElementById('score');
            
            for(let i=0; i<5; i++) {
                const b = document.createElement('div');
                b.className = 'strawberry-item'; b.innerHTML = 'ğŸ“';
                b.style.left = (10 + Math.random()*80) + '%';
                b.style.top = (10 + Math.random()*80) + '%';
                b.style.animationDelay = Math.random() + 's';
                b.onclick = function() {
                    this.style.transform = "scale(1.5) rotate(20deg)"; this.style.opacity = 0;
                    setTimeout(() => this.remove(), 500);
                    berryScore++;
                    score.innerText = berryScore + " / 5";
                    if(berryScore === 5) setTimeout(() => switchStage('stage2', 'stage3', initCake), 1500);
                }
                area.appendChild(b);
            }
        }

        // --- Stage 3 ---
        function initCake() {
            setTimeout(() => {
                document.getElementById('cake-model').classList.add('visible');
                document.getElementById('hint-text').style.opacity = 1;
                // ç»‘å®šç‚¹å‡»ï¼šç¡®ä¿æ˜¯ main-candle
                document.getElementById('main-candle').onclick = lightCandle;
                // èœ¡çƒ›é•¿é«˜
                document.getElementById('main-candle').style.height = "60px";
                
                // è‰è“å…¥åœº
                document.querySelectorAll('.c-berry').forEach(b => b.style.opacity = 1);
            }, 500);
        }

        function lightCandle() {
            const flame = document.getElementById('main-flame');
            if(flame.classList.contains('active')) return;
            
            // ç‚¹äº®ç«è‹—
            flame.classList.add('active');
            
            document.body.style.backgroundColor = "#1a1a1a"; 
            document.getElementById('glow').style.opacity = 1;
            
            document.getElementById('hint-text').innerHTML = "ç°åœ¨ï¼Œé—­ä¸Šçœ¼è®¸ä¸ªæ„¿...<br><span style='font-size:0.9rem;opacity:0.8'>ç„¶åå¹ç­å®ƒ</span>";
            const btn = document.getElementById('blow-btn');
            btn.style.opacity = 1; btn.style.pointerEvents = "all";
            
            initMic();
        }

        function blowOut() {
            const flame = document.getElementById('main-flame');
            if(!flame.classList.contains('active')) return;
            flame.classList.remove('active'); // ç†„ç­
            
            document.getElementById('glow').style.opacity = 0;
            document.getElementById('hint-text').style.opacity = 0;
            document.getElementById('blow-btn').style.opacity = 0;

            const rect = flame.getBoundingClientRect();
            const orb = document.getElementById('wish-orb');
            orb.style.left = (rect.left + rect.width/2 - 4) + 'px'; 
            orb.style.top = (rect.top + rect.height/2) + 'px';
            orb.style.opacity = 1;
            
            // å¯åŠ¨ç²’å­å¾ªç¯
            requestAnimationFrame(updateParticles);

            setTimeout(() => {
                document.body.style.backgroundColor = "#000";
                
                const cake = document.getElementById('cake-model');
                cake.style.transform = "translateY(200px)"; 
                cake.style.opacity = 0;
                // å½»åº•ç¦ç”¨è›‹ç³•å±‚ç‚¹å‡»
                document.getElementById('stage3').style.pointerEvents = "none";
                
                document.getElementById('cosmos-bg').style.opacity = 1;
                initStars();

                orb.style.transition = "top 5s cubic-bezier(0.4, 0, 0.2, 1)";
                requestAnimationFrame(() => orb.style.top = "15%");

                setTimeout(() => {
                    orb.style.opacity = 0;
                    createFireworks(window.innerWidth/2, window.innerHeight*0.15);
                }, 4800);
            }, 800);
        }

        // --- ç‰©ç†ç²’å­ç³»ç»Ÿ (é‡å†™XSé€»è¾‘ï¼Œå¢åŠ æ‹–å°¾) ---
        const canvas = document.getElementById('fireworks-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        let particles = [];

        function initStars() {
            const sky = document.getElementById('cosmos-bg');
            for(let i=0; i<100; i++) {
                const s = document.createElement('div');
                // æµæ˜Ÿé›¨æ•ˆæœ
                s.style.cssText = `position:absolute; background:linear-gradient(to right, rgba(255,255,255,0), #fff); width:${Math.random()*100+50}px; height:1px; left:${Math.random()*100}%; top:${Math.random()*100}%; opacity:${Math.random()}; transform: rotate(-45deg); animation: shootingStar ${Math.random()*5+3}s infinite linear; animation-delay: ${Math.random()*5}s;`;
                sky.appendChild(s);
            }
        }

        function createFireworks(x, y) {
            // Heart (Ruby Red, Denser)
            for(let i=0; i<60; i++) {
                const t = (Math.PI*2*i)/120;
                const dx = 16 * Math.pow(Math.sin(t), 3);
                const dy = -(13 * Math.cos(t) - 5 * Math.cos(2*t) - 2 * Math.cos(3*t) - Math.cos(4*t));
                particles.push(new Particle(x + dx*6, y + dy*6, 0, 0, '#E0115F', true)); // True for trail
            }
            
            const gold = '#FFD700';
            // X (Rigid shape)
            const gx = x - 140;
            for(let i=0; i<=40; i++) {
                let d = i*2; // 0 to 80
                particles.push(new Particle(gx-40+d, y-40+d, 0, 0, gold, true)); // \
                particles.push(new Particle(gx-40+d, y+40-d, 0, 0, gold, true)); // /
            }
            
            // S (Rigid shape using arcs)
            const sx = x + 140;
            // Top arc (from -45 to 225 degrees)
            for(let i=0; i<=50; i++) {
                let a = (-Math.PI/4) + (i/50) * (Math.PI*1.5);
                particles.push(new Particle(sx + 30*Math.cos(a), (y-30) + 30*Math.sin(a), 0,0, gold, true));
            }
             // Bottom arc (from 135 to 405 degrees)
            for(let i=0; i<=50; i++) {
                let a = (Math.PI*0.75) + (i/50) * (Math.PI*1.5);
                particles.push(new Particle(sx + 30*Math.cos(a), (y+30) + 30*Math.sin(a), 0,0, gold, true));
            }

            // Explosion Filler Particles
            for(let i=0; i<50; i++) {
                const a = Math.random()*Math.PI*2; const v = Math.random()*4;
                particles.push(new Particle(x, y, Math.cos(a)*v, Math.sin(a)*v, gold, true));
            }

            setTimeout(() => {
                const bar = document.getElementById('control-bar');
                bar.style.opacity = 1; bar.style.pointerEvents = "all";
            }, 6000);
        }

        class Particle {
            constructor(x, y, vx, vy, color, useTrail) {
                this.x = x; this.y = y; this.vx = vx; this.vy = vy;
                this.color = color; this.alpha = 1; this.size = Math.random()*2+1;
                this.useTrail = useTrail;
                this.trail = [];
            }
            update() {
                if(this.useTrail) {
                    this.trail.push({x:this.x, y:this.y, alpha:this.alpha});
                    if(this.trail.length > 10) this.trail.shift();
                }
                this.x += this.vx; this.y += this.vy;
                this.vx *= 0.96; this.vy *= 0.96; // Friction
                this.vy += 0.02; // Gravity
                this.alpha -= 0.004; // Slow fade
            }
            draw(ctx) {
                // Draw trail
                if(this.useTrail) {
                    ctx.beginPath();
                    for(let i=0; i<this.trail.length; i++) {
                        const t = this.trail[i];
                        ctx.globalAlpha = t.alpha * (i/this.trail.length);
                        ctx.fillStyle = this.color;
                        ctx.arc(t.x, t.y, this.size * (i/this.trail.length), 0, Math.PI*2);
                        ctx.fill();
                    }
                }
                // Draw main particle
                ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(this.x, this.y, this.size, 0, Math.PI*2); ctx.fill();
            }
        }

        function updateParticles() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            // Draw particles in reverse to handle transparency better
            for(let i=particles.length-1; i>=0; i--) {
                particles[i].update(); particles[i].draw(ctx);
                if(particles[i].alpha <= 0) particles.splice(i, 1);
            }
            requestAnimationFrame(updateParticles);
        }

        // --- å­”æ˜ç¯ç…§ç‰‡ ---
        function showLanterns() {
            document.getElementById('photo-btn').style.display = 'none';
            document.getElementById('star-msg').innerText = "å›å¿†æ­£åœ¨å‡ç©º...";
            
            const container = document.getElementById('lantern-container');
            
            photos.forEach((p, i) => {
                const div = document.createElement('div');
                div.className = 'lantern';
                div.innerHTML = `<img src="${p.src}">`;
                div.style.left = (15 + Math.random()*70) + '%';
                div.style.animationDuration = (20 + Math.random()*10) + 's';
                div.style.animationDelay = (i * 2) + 's';
                
                div.onclick = () => {
                    document.getElementById('modal-img').src = p.src;
                    document.getElementById('modal-text').innerText = p.text;
                    document.getElementById('modal').classList.add('show');
                };
                container.appendChild(div);
            });

            setTimeout(() => {
                document.getElementById('read-letter-btn').style.display = 'inline-block';
            }, 6000);
        }
        
        function closeModal() { document.getElementById('modal').classList.remove('show'); }

        // --- ä¿¡ä»¶ (ä¿®å¤) ---
        function revealLetter() {
            switchStage(null, 'stage5', () => {
                document.body.style.backgroundColor = "var(--bg-paper)";
                document.getElementById('cosmos-bg').style.display = 'none';
                document.getElementById('lantern-container').style.display = 'none';
                document.getElementById('control-bar').style.display = 'none';
                
                const box = document.getElementById('letter-box');
                box.style.opacity = 1;
                document.getElementById('letter-content').innerHTML = letterText;
                
                startTimer();
            });
        }

        function startTimer(){ setInterval(() => { const diff = new Date("2025-12-09T00:00:00") - new Date(); if(diff<0) return; const d = Math.floor(diff/(1000*60*60*24)); const h = Math.floor((diff%(1000*60*60*24))/(1000*60*60)); document.getElementById('timer').innerText = `${d}å¤© ${h}å°æ—¶`; }, 1000); }
        function initMic() { if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) { navigator.mediaDevices.getUserMedia({ audio: true }).then(stream => { const ctx = new AudioContext(); const ana = ctx.createAnalyser(); const src = ctx.createMediaStreamSource(stream); src.connect(ana); const data = new Uint8Array(ana.frequencyBinCount); function loop(){ ana.getByteFrequencyData(data); let s=0; data.forEach(v=>s+=v); if(s/data.length>30) blowOut(); else requestAnimationFrame(loop); } loop(); }).catch(()=>{}); } }
        function toggleMusic(){bgm.paused?bgm.play():bgm.pause();}
        
        const style = document.createElement('style');
        style.innerHTML = `@keyframes fadeIn { from{opacity:0; transform:translateY(20px);} to{opacity:1; transform:translateY(0);} } @keyframes shootingStar { 0% { transform: translateX(0) translateY(0) rotate(-45deg); opacity: 1; } 100% { transform: translateX(-500px) translateY(500px) rotate(-45deg); opacity: 0; } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
